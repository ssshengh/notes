# Gradle æ’ä»¶

Gradle å’Œ Gradle æ’ä»¶æ˜¯ä¸¤ä¸ªå®Œå…¨ä¸åŒçš„æ¦‚å¿µï¼ŒGradle æä¾›çš„æ˜¯ä¸€å¥—æ ¸å¿ƒçš„æ„å»ºæœºåˆ¶ï¼Œè€Œ Gradle æ’ä»¶åˆ™æ˜¯è¿è¡Œåœ¨è¿™å¥—æœºåˆ¶ä¸Šçš„ä¸€äº›å…·ä½“æ„å»ºé€»è¾‘ï¼Œæœ¬è´¨ä¸Šå’Œ .gradle æ–‡ä»¶æ˜¯ç›¸åŒã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬ç†Ÿæ‚‰çš„ç¼–è¯‘ Java ä»£ç çš„èƒ½åŠ›ï¼Œéƒ½æ˜¯ç”±æ’ä»¶æä¾›çš„ã€‚

è™½ç„¶ Gradle æ’ä»¶ä¸ .gradle æ–‡ä»¶æœ¬è´¨ä¸Šæ²¡æœ‰åŒºåˆ«ï¼Œ.gradle æ–‡ä»¶ä¹Ÿèƒ½å®ç° Gradle æ’ä»¶ç±»ä¼¼çš„åŠŸèƒ½ã€‚ä½†æ˜¯ï¼ŒGradle æ’ä»¶ä½¿ç”¨äº†ç‹¬ç«‹æ¨¡å—å°è£…æ„å»ºé€»è¾‘ï¼Œæ— è®ºæ˜¯ä»å¼€å‘å¼€å§‹ä½¿ç”¨æ¥çœ‹ï¼ŒGradle æ’ä»¶çš„æ•´ä½“ä½“éªŒéƒ½æ›´å‹å¥½ã€‚

- **é€»è¾‘å¤ç”¨ï¼š** å°†ç›¸åŒçš„é€»è¾‘æä¾›ç»™å¤šä¸ªç›¸ä¼¼é¡¹ç›®å¤ç”¨ï¼Œå‡å°‘é‡å¤ç»´æŠ¤ç±»ä¼¼é€»è¾‘å¼€é”€ã€‚å½“ç„¶ .gradle æ–‡ä»¶ä¹Ÿèƒ½åšåˆ°é€»è¾‘å¤ç”¨ï¼Œä½† Gradle æ’ä»¶çš„å°è£…æ€§æ›´å¥½ï¼›
- **ç»„ä»¶å‘å¸ƒï¼š** å¯ä»¥å°†æ’ä»¶å‘å¸ƒåˆ° Maven ä»“åº“è¿›è¡Œç®¡ç†ï¼Œå…¶ä»–é¡¹ç›®å¯ä»¥ä½¿ç”¨æ’ä»¶ ID ä¾èµ–ã€‚å½“ç„¶ .gradle æ–‡ä»¶ä¹Ÿå¯ä»¥æ”¾åˆ°ä¸€ä¸ªè¿œç¨‹è·¯å¾„è¢«å…¶ä»–é¡¹ç›®å¼•ç”¨ï¼›
- **æ„å»ºé…ç½®ï¼š** Gradle æ’ä»¶å¯ä»¥å£°æ˜æ’ä»¶æ‰©å±•æ¥æš´éœ²å¯é…ç½®çš„å±æ€§ï¼Œæä¾›å®šåˆ¶åŒ–èƒ½åŠ›ã€‚å½“ç„¶ .gradle æ–‡ä»¶ä¹Ÿå¯ä»¥åšåˆ°ï¼Œä½†å®ç°ä¼šéº»çƒ¦äº›ã€‚

# ä¸€ã€åŸºæœ¬ä½¿ç”¨

## 1.1 æ’ä»¶çš„ä¸¤ç§å®ç°å½¢å¼

Gradle æ’ä»¶çš„æ ¸å¿ƒç±»æ˜¯ Pluginï¼Œä¸€èˆ¬ä½¿ç”¨ Project ä½œä¸ºæ³›å‹å®å‚ã€‚å½“ä½¿ç”¨æ–¹å¼•å…¥æ’ä»¶åï¼Œå…¶å®å°±æ˜¯è°ƒç”¨äº† `Plugin#apply()` æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠ apply() æ–¹æ³•ç†è§£ä¸ºæ’ä»¶çš„æ‰§è¡Œå…¥å£ã€‚ä¾‹å¦‚ï¼š

```groovy
MyCustomGradlePlugin.groovy

public class MyCustomGradlePlugin implements Plugin<Project> {
    @Override
    void apply(Project project) {
        println "Hello."
    }
}
```

å¦‚æœæ ¹æ®å®ç°å½¢å¼åˆ†ç±»ï¼ˆMyCustomGradlePlugin çš„ä»£ç ä½ç½®ï¼‰ï¼Œå¯ä»¥æŠŠ Gradle æ’ä»¶åˆ†ä¸º 2 ç±»ï¼š

- **1ã€è„šæœ¬æ’ä»¶ï¼š** è„šæœ¬æ’ä»¶å°±æ˜¯ä¸€ä¸ªæ™®é€šçš„è„šæœ¬æ–‡ä»¶ï¼Œå®ƒå¯ä»¥è¢«å¯¼å…¥éƒ½å…¶ä»–æ„å»ºè„šæœ¬ä¸­ã€‚æœ‰çš„æœ‹å‹è¯´è„šæœ¬æ’ä»¶ä¹Ÿéœ€è¦ä½¿ç”¨ Plugin æ¥å£æ‰ç®—è„šæœ¬æ’ä»¶ï¼Œä¾‹å¦‚ï¼š

```
build.gradle

apply plugin: MyCustomGradlePlugin

class MyCustomGradlePlugin implements Plugin<Project> {
    ...
}
```

- **2ã€äºŒè¿›åˆ¶æ’ä»¶ / å¯¹è±¡æ’ä»¶ï¼š** åœ¨ä¸€ä¸ªå•ç‹¬çš„æ’ä»¶æ¨¡å—ä¸­å®šä¹‰ï¼Œå…¶ä»–æ¨¡å—é€šè¿‡ Plugin ID åº”ç”¨æ’ä»¶ã€‚å› ä¸ºè¿™ç§æ–¹å¼å‘å¸ƒå’Œå¤ç”¨æ›´åŠ å‹å¥½ï¼Œæˆ‘ä»¬ä¸€èˆ¬æ¥è§¦åˆ°çš„ Gradle æ’ä»¶éƒ½æ˜¯æŒ‡äºŒè¿›åˆ¶æ’ä»¶çš„å½¢å¼ã€‚

## 1.2 åº”ç”¨æ’ä»¶

æˆ‘ä»¬æ€»ç»“ä¸‹ä½¿ç”¨äºŒè¿›åˆ¶æ’ä»¶çš„æ­¥éª¤ï¼š

- **1ã€å°†æ’ä»¶æ·»åŠ åˆ° classpathï¼š** å°†æ’ä»¶æ·»åŠ åˆ°æ„å»ºè„šæœ¬çš„ classpath ä¸­ï¼Œæˆ‘ä»¬çš„ Gradle æ„å»ºè„šæœ¬æ‰èƒ½åº”ç”¨æ’ä»¶ã€‚è¿™é‡ŒåŒºåˆ†æœ¬åœ°ä¾èµ–å’Œè¿œç¨‹ä¾èµ–ä¸¤ç§æƒ…å†µã€‚

**æœ¬åœ°ä¾èµ–ï¼š** æŒ‡ç›´æ¥ä¾èµ–æœ¬åœ°æ’ä»¶æºç ï¼Œä¸€èˆ¬åœ¨è°ƒè¯•æ’ä»¶çš„é˜¶æ®µæ˜¯ä½¿ç”¨æœ¬åœ°ä¾èµ–çš„æ–¹å¼ã€‚ä¾‹å¦‚ï¼š

```groovy
é¡¹ç›®çº§ build.gradle

buildscript {
    ...
    dependencies {
        // For Debug
        classpath project(":easyupload")
    }
}
```

**è¿œç¨‹ä¾èµ–ï¼š** æŒ‡ä¾èµ–å·²å‘å¸ƒåˆ° Maven ä»“åº“çš„æ’ä»¶ï¼Œä¸€èˆ¬æˆ‘ä»¬éƒ½æ˜¯ç”¨è¿™ç§æ–¹å¼ä¾èµ–å®˜æ–¹æˆ–ç¬¬ä¸‰æ–¹å®ç°çš„ Gradle æ’ä»¶ã€‚ä¾‹å¦‚ï¼š

```groovy
é¡¹ç›® build.gradle

buildscript {
    repositories {
        google()
        jcenter()
    }
    dependencies {
        classpath 'com.android.tools.build:gradle:3.5.3'
        // ä¹Ÿå¯ä»¥ä½¿ç”¨å¦ä¸€ç§ç­‰ä»·è¯­æ³•ï¼š
        classpath group: 'com.android.tools.build ', name: 'gradle ', version: '3.5.3'
    }
    ...
}
```

- **2ã€ä½¿ç”¨ apply åº”ç”¨æ’ä»¶ï¼š** åœ¨éœ€è¦ä½¿ç”¨æ’ä»¶çš„ .gradle è„šæœ¬ä¸­ä½¿ç”¨ `apply` åº”ç”¨æ’ä»¶ï¼Œè¿™å°†åˆ›å»ºä¸€ä¸ªæ–°çš„ Plugin å®ä¾‹ï¼Œå¹¶æ‰§è¡Œ Plugin#apply() æ–¹æ³•ã€‚ä¾‹å¦‚ï¼š

```groovy
apply plugin: 'com.android.application'

// æˆ–è€…

plugins {
    // id Â«plugin idÂ» [version Â«plugin versionÂ»] [apply Â«falseÂ»]
    id 'com.android.application'
}
```

> **æ³¨æ„ï¼š** ä¸æ”¯æŒåœ¨ä¸€ä¸ª build.gradle ä¸­åŒæ—¶ä½¿ç”¨è¿™ä¸¤ç§è¯­æ³•ã€‚

## 1.3 ç‰¹æ®Šçš„ buildSrc æ¨¡å—

æ’ä»¶æ¨¡å—çš„åç§°æ˜¯ä»»æ„çš„ï¼Œé™¤éä½¿ç”¨äº†ä¸€ä¸ªç‰¹æ®Šçš„åç§° â€œbuildSrcâ€ï¼ŒbuildSrc æ¨¡å—æ˜¯ Gradle é»˜è®¤çš„æ’ä»¶æ¨¡å—ã€‚buildSrc æ¨¡å—æœ¬è´¨ä¸Šå’Œæ™®é€šçš„æ’ä»¶æ¨¡å—æ˜¯ä¸€æ ·çš„ï¼Œæœ‰ä¸€äº›å°åŒºåˆ«ï¼š

- 1ã€buildSrc æ¨¡å—ä¼šè¢«è‡ªåŠ¨è¯†åˆ«ä¸ºå‚ä¸æ„å»ºçš„æ¨¡å—ï¼Œå› æ­¤ä¸éœ€è¦åœ¨ settings.gradle ä¸­ä½¿ç”¨ include å¼•å…¥ï¼Œå°±ç®—å¼•å…¥äº†ä¹Ÿä¼šç¼–è¯‘å‡ºé”™ï¼š

```kotlin
Build OutPutï¼š
'buildSrc' cannot be used as a project name as it is a reserved name
```

- 2ã€buildSrc æ¨¡å—ä¼šè‡ªåŠ¨è¢«æ·»åŠ åˆ°æ„å»ºè„šæœ¬çš„ classpath ä¸­ï¼Œä¸éœ€è¦æ‰‹åŠ¨æ·»åŠ ï¼š

```kotlin
buildscript {
    ...
    dependencies {
        // ä¸éœ€è¦æ‰‹åŠ¨æ·»åŠ 
        // classpath project(":buildSrc")
    }
}
```

- 3ã€buildSrc æ¨¡å—çš„ build.gradle æ‰§è¡Œæ—¶æœºæ—©äºå…¶ä»– Projectï¼š

```kotlin
Executing tasks: [test] 

settings.gradle:This is executed during the initialization phase.

> Configure project :buildSrc
build.gradle:buildSrc.

> Task :buildSrc:compileJava NO-SOURCE
> Task :buildSrc:compileGroovy NO-SOURCE
> Task :buildSrc:pluginDescriptors UP-TO-DATE
> Task :buildSrc:processResources NO-SOURCE
> Task :buildSrc:classes UP-TO-DATE
> Task :buildSrc:jar UP-TO-DATE
> Task :buildSrc:assemble UP-TO-DATE
> Task :buildSrc:pluginUnderTestMetadata UP-TO-DATE
> Task :buildSrc:compileTestJava NO-SOURCE
> Task :buildSrc:compileTestGroovy NO-SOURCE
> Task :buildSrc:processTestResources NO-SOURCE
> Task :buildSrc:testClasses UP-TO-DATE
> Task :buildSrc:test NO-SOURCE
> Task :buildSrc:validatePlugins UP-TO-DATE
> Task :buildSrc:check UP-TO-DATE
> Task :buildSrc:build UP-TO-DATE
...
> Configure project :
...
> Task :test
...
BUILD SUCCESSFUL in 19s
```

![img](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4bfba88dc16548bb876064abdc83937e~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

# äºŒã€å…·ä½“å®è·µ

åŸºæœ¬æ­¥éª¤åˆ†ä¸º 5 æ­¥ï¼š

- 1ã€åˆå§‹åŒ–æ’ä»¶ç›®å½•ç»“æ„
- 2ã€åˆ›å»ºæ’ä»¶å®ç°ç±»
- 3ã€é…ç½®æ’ä»¶å®ç°ç±»
- 4ã€å‘å¸ƒæ’ä»¶
- 5ã€ä½¿ç”¨æ’ä»¶

## 2.1 åˆå§‹åŒ–æ’ä»¶ç›®å½•ç»“æ„

é¦–å…ˆï¼Œæˆ‘ä»¬åœ¨ Android Studio æ–°å»ºä¸€ä¸ª `Java or Kotlin Library` æ¨¡å—ï¼Œè¿™é‡Œä»¥é buildSrc æ¨¡å—çš„æƒ…å†µä¸ºä¾‹ï¼š

![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c73e8032f02c4d158b423f2ff30849dd~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

åˆ›å»ºå®Œæ¯•ä¹‹åæ˜¯è¿™æ ·ï¼š

<img src="/Users/bytedance/Library/Application Support/typora-user-images/image-20230719195717611.png" alt="image-20230719195717611" style="zoom:50%;" />

æ›¿æ¢ bulid.gradle ä¸ºï¼š

```groovy
plugins {
    id 'groovy'// Groovy Language
    id 'org.jetbrains.kotlin.jvm'
    id 'java-gradle-plugin' // Java Gradle Plugin
}

java {
    sourceCompatibility = JavaVersion.VERSION_1_8
    targetCompatibility = JavaVersion.VERSION_1_8
}
```

**groovy æ’ä»¶ï¼š** ä½¿ç”¨ Groovy è¯­è¨€å¼€å‘å¿…å¤‡ï¼›

**org.jetbrains.kotlin.jvm æ’ä»¶ï¼š** ä½¿ç”¨ Kotlin è¯­è¨€å¼€å‘å¿…å¤‡ï¼›

**java-gradle-plugin æ’ä»¶ï¼š** ç”¨äºå¸®åŠ©å¼€å‘ Gradle æ’ä»¶ï¼Œä¼šè‡ªåŠ¨åº”ç”¨ [Java Library æ’ä»¶](https://link.juejin.cn?target=https%3A%2F%2Fdocs.gradle.org%2Fcurrent%2Fuserguide%2Fjava_library_plugin.html%23java_library_plugin)ï¼Œå¹¶åœ¨ dependencies ä¸­æ·»åŠ  `implementation gradleApi()`ã€‚

æœ€åï¼Œæ ¹æ®ä½ éœ€è¦çš„å¼€å‘è¯­è¨€è¡¥å……å¯¹åº”çš„æºç æ–‡ä»¶å¤¹ï¼Œä¸åŒè¯­è¨€æœ‰é»˜è®¤çš„æºç æ–‡ä»¶å¤¹ï¼Œä½ ä¹Ÿå¯ä»¥åœ¨ build.gradle æ–‡ä»¶ä¸­é‡æ–°æŒ‡å®šï¼š

```
plugins {
    id 'groovy' // Groovy Language
    id 'org.jetbrains.kotlin.jvm' // Kotlin 
    id 'java-gradle-plugin' // Java Gradle Plugin
}

sourceSets {
    main {
        groovy {
            srcDir 'src/main/groovy'
        }

        java {
            srcDir 'src/main/java'
        }

        resources {
            srcDir 'src/main/resources'
        }
    }
}
```

ä¸è¿‡ä¸€èˆ¬æˆ‘ä»¬ä¸åŒºåˆ† java å’Œ kotlinã€‚

## 2.2 åˆ›å»ºæ’ä»¶å®ç°ç±»

æ–°å»ºä¸€ä¸ª Plugin å®ç°ç±»ï¼Œå¹¶é‡å†™ apply æ–¹æ³•ä¸­æ·»åŠ æ„å»ºé€»è¾‘ï¼Œä¾‹å¦‚ï¼š

```java
class EasyUpload implements Plugin<Project> {

    @Override
    void apply(Project project) {
        // æ„å»ºé€»è¾‘
        println "Hello."
    }
}
```

## 2.3 é…ç½®å¹¶å‘å¸ƒ

åœ¨é…ç½®ä¸Šé¢æœ‰ä¸¤ç§ç­–ç•¥ï¼š

1. å®˜æ–¹æ¨èçš„ä½¿ç”¨ gradle çš„æ’ä»¶æ¥å‘å¸ƒåˆ° gradle çš„æ’ä»¶ä»“åº“ã€‚è¿™é‡Œä¸å¤šè¯´ï¼Œè¿™ç§æ–¹å¼ä½¿ç”¨è¾ƒå°‘ï¼š[å®˜æ–¹æ–‡æ¡£](https://docs.gradle.org/current/userguide/publishing_gradle_plugins.html#custom-plugin-repositories)
2. ä½¿ç”¨ maven çš„æ’ä»¶æ¥å®Œæˆå‘å¸ƒ

ä»¥ä¸‹ä»¥ç¬¬äºŒç§æ–¹æ³•æ¥è¿›è¡Œé…ç½®å¹¶å‘å¸ƒã€‚

é¦–å…ˆéœ€è¦å¼•å…¥ maven çš„å‘å¸ƒæ’ä»¶ï¼š

```
// åœ¨æ’ä»¶æ¨¡å—å¯¹åº”çš„æ¨¡å—çº§ build.gradle

plugins {
    id 'maven-publish'
}
```

<img src="/Users/bytedance/Library/Application Support/typora-user-images/image-20230720164125320.png" alt="image-20230720164125320" style="zoom:50%;" />

å¦‚ä¸Šå›¾ï¼Œç„¶åæ–°å»º resources åŠå†…éƒ¨æ–‡ä»¶ï¼Œå°¤å…¶æ˜¯`com.example.easyupload.properties`ï¼Œæ³¨æ„åç§°éœ€è¦å’ŒåŒ…åå¯¹åº”ï¼Œå†…éƒ¨å†™ä¸Šå®ç°ç±»ï¼š

```
implementation-class=com.example.easyupload.EasyUpload
```

ä¸Šé¢çš„å†™æ³•æœ¬è´¨ä¸Šæ˜¯ä»¥ä¸‹å†™æ³•çš„ç¼©å†™ï¼š

```groovy
gradlePlugin {
    plugins {
        modularPlugin {
            // Plugin id.
            id = 'com.example.easyupload'
            // Plugin implementation.
            implementationClass = 'com.example.easyupload.EasyUpload'
        }
    }
}
```

å…¶ plugin id ç”¨äºæœ€åè°ƒç”¨æ—¶ï¼Œä¹Ÿå³è°ƒç”¨æ—¶åº”è¯¥å†™ï¼š

```groovy
apply plugin: 'com.example.easyupload'
```



å®Œæˆä»¥ä¸Šä¸¤æ­¥ä¹‹åï¼Œå°±è¦å‘å¸ƒæ’ä»¶äº†ï¼Œä¸ç„¶æ— æ³•ä½¿ç”¨æ’ä»¶ã€‚

>  å‘å¸ƒçš„åŸºç¡€çŸ¥è¯†è§[å½­ä½¬çš„æ–‡ç« ](https://juejin.cn/post/6963633839860088846#heading-14)

å‘å¸ƒæ—¶ï¼Œæˆ‘ä»¬ä¸»è¦æ˜¯è°ƒç”¨`maven-plugin`æ’ä»¶æä¾›çš„æ’ä»¶ plushing å®Œæˆï¼š

```groovy
publishing {
    // é…ç½® maven ä»“åº“
    repositories { RepositoryHandler handler->
        handler.mavenLocal()  // å‘å¸ƒåˆ°é»˜è®¤çš„ æœ¬åœ°maven ä»“åº“ ï¼Œè·¯å¾„ï¼š USER_HOME/.m2/repository/
        // æœ¬åœ°å…¶ä»–mavenä»“åº“
        // maven { url uri('/Users/h__d/Desktop/1') }
      
        // aliyuné•œåƒä»“åº“
//         maven {
//             // å‡­è¯
//             credentials {
//                 username 'username' // ä»“åº“å‘å¸ƒç”¨æˆ·å
//                 password 'password' // ä»“åº“å‘å¸ƒç”¨æˆ·å¯†ç 
//             }
//             // åœ°å€
//             url 'https://maven.aliyun.com/nexus/content/groups/public/'
//         }
      
    }
    // é…ç½®å‘å¸ƒäº§ç‰©
    publications {
        myLibrary(MavenPublication) {
            group 'com.example'
            artifactId 'easyupload'
            version '1.0.0'
          	// æŒ‡å®šå‘å¸ƒ jar åŒ…
            from components.java
        }
    }
  		// ä¸ä»…ä»…æ˜¯å‘å¸ƒæ’ä»¶ï¼Œè¿˜å¯ä»¥å‘å¸ƒ aar åŒ…
//    publications {PublicationContainer publication->
//        // åç§°å¯ä»¥éšä¾¿å®šä¹‰ï¼Œè¿™é‡Œå®šä¹‰æˆ mavenï¼Œæ˜¯å› ä¸ºæˆ‘çš„ aar åŒ…æ˜¯å‘å¸ƒåˆ° maven ä»“åº“çš„ï¼Œæ‰€ä»¥è¿™é‡Œä¸ºäº†è§åçŸ¥ä¹‰ï¼Œå®šä¹‰æˆäº† maven
//        // ä»»åŠ¡åç§°ï¼šmaven
//        maven(MavenPublication) {// å®¹å™¨å¯é…ç½®çš„ä¿¡æ¯ MavenPublication
//            // ä¾èµ– bundleReleaseAar ä»»åŠ¡ï¼Œå¹¶ä¸Šä¼ å…¶äº§å‡ºçš„aar
//            afterEvaluate { artifact(tasks.getByName("bundleReleaseAar")) } // æ–¹å¼ä¸€ï¼šç”ŸæˆaaråŒ…
//            // artifact "$buildDir/outputs/aar/${project.name}-release.aar" // æ–¹å¼äºŒï¼šæŒ‡å®šç”Ÿæˆçš„aarè·¯å¾„
//            groupId = "com.mei.http"
//            artifactId = "myhttp"
//            version = "1.0.4-SNAPSHOT"
//        }
//    }
}
```

ä¸Šè¿°é…ç½®ä¸»è¦æ˜¯é…ç½®åœ¨æœ¬åœ°ä»“åº“çš„å­˜å‚¨æ–‡ä»¶å±‚çº§ï¼Œå‘å¸ƒä¹‹åå¦‚ä¸‹æ‰€ç¤ºï¼š

![image-20230720165514063](/Users/bytedance/Library/Application Support/typora-user-images/image-20230720165514063.png)

æˆ‘ä»¬è¿›å…¥å°±å¯ä»¥çœ‹åˆ° jar åŒ…:

![image-20230720165816240](/Users/bytedance/Library/Application Support/typora-user-images/image-20230720165816240.png)

POMï¼ˆProject Object Modelï¼‰æŒ‡é¡¹ç›®å¯¹è±¡æ¨¡å‹ï¼Œç”¨äºæè¿°é¡¹ç›®æ„ä»¶çš„åŸºæœ¬ä¿¡æ¯ã€‚ä¸€ä¸ªæœ‰æ•ˆçš„ POM èŠ‚ç‚¹ä¸­ä¸»è¦åŒ…å«ä¸€ä¸‹ä¿¡æ¯ï¼š

![image-20230720165844885](/Users/bytedance/Library/Application Support/typora-user-images/image-20230720165844885.png)

ä½†æ˜¯å…‰é…ç½®å®Œæ˜¯ä¸ä¼šå‘å¸ƒçš„ï¼Œæˆ‘ä»¬éœ€è¦æ‰‹åŠ¨æ‰§è¡Œä¸€ä¸‹å‘½ä»¤ï¼š

```
> gradle :easyupload:publishToMavenLocal
```

å¦‚æœ Android Studio ä¸æŠ½é£çš„è¯ï¼Œæ—è¾¹èƒ½å¤Ÿç›´æ¥æ‰§è¡Œï¼š

<img src="/Users/bytedance/Library/Application Support/typora-user-images/image-20230720170036528.png" alt="image-20230720170036528" style="zoom:50%;" />

## 2.4 ä½¿ç”¨æ’ä»¶

åœ¨ settings.gradle ä¸­æœ¬åœ° plugins ä»“åº“ï¼š

```
pluginManagement {
    repositories {
        google()
        mavenCentral()
        gradlePluginPortal()
        // æœ¬åœ° plugin ä»“åº“
        mavenLocal()
    }
}
```

ç„¶ååœ¨é¡¹ç›®çº§ build.gradle ä¸­éœ€è¦å°†æ’ä»¶æ·»åŠ åˆ° classpathï¼š

```
buildscript {
    dependencies {
        // For debug
        // classpath project(":easyupload")
        classpath "com.example:easyupload:1.0.0" // æœ¬è´¨ä¸Šå°±æ˜¯ä¸Šé¢å†™çš„å‡ ä¸ªä¿¡æ¯æ­å»ºçš„æ–‡ä»¶ç»“æ„
    }
}
```

è¿™äºŒè€…å¯ä»¥åˆæˆåœ¨é¡¹ç›®çº§ build.gradle ä¸­å†™ä¸ºï¼š

```
buildscript {
    repositories {
        google()
        jcenter()
        mavenLocal()
    }
    dependencies {
        // For debug
        // classpath project(":easyupload")
        classpath "com.pengxr:easyupload:1.0.0"
    }
    ...
}
```

ç„¶åæˆ‘ä»¬å°±èƒ½åœ¨é¡¹ç›®çš„ä»»ä½•ä¸€ä¸ªæ¨¡å—ä¸­é€šè¿‡:

```
apply plugin: 'com.example.easyupload'
```

æ¥åº”ç”¨æ’ä»¶å•¦ã€‚

## 2.5 é…ç½®æ’ä»¶æ‹“å±•

Extension æ‰©å±•æ˜¯æ’ä»¶ä¸ºå¤–éƒ¨æ„å»ºè„šæœ¬æä¾›çš„é…ç½®é¡¹ï¼Œç”¨äºæ”¯æŒå¤–éƒ¨è‡ªå®šä¹‰æ’ä»¶çš„å·¥ä½œæ–¹å¼ï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªå¯¹å¤–å¼€æ”¾çš„ Java Bean æˆ– Groovy Beanã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬ç†Ÿæ‚‰çš„ `android{}` å°±æ˜¯ Android Gradle Plugin æä¾›çš„æ‰©å±•ã€‚

å½“ä½ åº”ç”¨ä¸€ä¸ªæ’ä»¶æ—¶ï¼Œæ’ä»¶å®šä¹‰çš„æ‰©å±•ä¼šä»¥ `æ‰©å±•å-æ‰©å±•å¯¹è±¡` é”®å€¼å¯¹çš„å½¢å¼ä¿å­˜åœ¨ Project ä¸­çš„ [ExtensionContainer](https://link.juejin.cn?target=https%3A%2F%2Fdocs.gradle.org%2Fcurrent%2Fjavadoc%2Forg%2Fgradle%2Fapi%2Fplugins%2FExtensionContainer.html) å®¹å™¨ä¸­ã€‚æ’ä»¶å†…å¤–éƒ¨ä¹Ÿæ˜¯é€šè¿‡ ExtensionContainer è®¿é—®æ‰©å±•å¯¹è±¡çš„ã€‚

æ³¨æ„äº‹é¡¹ï¼š

- **æ‰©å±•åï¼š** ä¸æ”¯æŒåœ¨åŒä¸€ä¸ª Project ä¸Šæ·»åŠ é‡å¤çš„æ‰©å±•åï¼›
- **æ˜ å°„å…³ç³»ï¼š** æ·»åŠ æ‰©å±•åï¼Œä¸æ”¯æŒé‡æ–°è®¾ç½®æ‰©å±•å¯¹è±¡ï¼›
- **DSLï¼š** æ”¯æŒç”¨ `æ‰©å±•å {}` DSL çš„å½¢å¼è®¿é—®æ‰©å±•å¯¹è±¡ã€‚

å…·ä½“æ¥å®ç°æ‹“å±•æ—¶ï¼Œæˆ‘ä»¬é¦–å…ˆä¿®æ”¹ pluginï¼Œå¹¶æœé‡Œé¢æ·»åŠ æ‹“å±•å¯¹è±¡ï¼š

```kotlin
package com.example.easyupload

import org.gradle.api.Plugin
import org.gradle.api.Project

open class EasyUpload: Plugin<Project> {
    override fun apply(target: Project) {
        println("----------------")
        println("Hello plugin!!!")
        println("----------------")

      	// åœ¨ project æ³¨å†Œæ‹“å±•å¯¹è±¡
        val cl = target.extensions.create("cl", EuExtension::class.java)
				// æ­¤æ—¶èƒ½å¤Ÿæ‹¿åˆ°æ³¨å†Œè¿›å»çš„æ‹“å±•ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰ä¿¡æ¯çš„è¯å°±æ˜¯é»˜è®¤å€¼
      	// æ³¨æ„è·å–çš„æ—¶æœº!!!!!
        target.afterEvaluate {
            println("++++++++++++++++++")
            println("name=${cl.name}, id=${cl.id}")
            println("++++++++++++++++++")
        }
      
    }
}

// æ‹“å±•å¯¹è±¡, æ³¨æ„ä¸€å®šè¦æ˜¯ open çš„ï¼Œä¹Ÿå³é final çš„ï¼Œä¸ç„¶ä¸èƒ½è¢«åˆ›å»ºï¼Œå› ä¸ºå®ƒä¼šè¢«ç»§æ‰¿
open class EuExtension {
    var name = ""
    var id = ""
}
```

> ä½¿ç”¨æ’ä»¶æ‰©å±•ä¸€å®šä¼šç”¨åˆ° `project.afterEvaluate()` ç”Ÿå‘½å‘¨æœŸç›‘å¬ï¼Œè¿™é‡Œè§£é‡Šä¸€ä¸‹ï¼šå› ä¸ºæ‰©å±•é…ç½®ä»£ç çš„æ‰§è¡Œæ—¶æœºæ™šäº Plugin#apply() çš„æ‰§è¡Œæ—¶æœºï¼Œæ‰€ä»¥å¦‚æœä¸ä½¿ç”¨ project.afterEvaluate()ï¼Œåˆ™åœ¨æ’ä»¶å†…éƒ¨å°†æ— æ³•æ­£ç¡®è·å–é…ç½®å€¼ã€‚
>
> project.afterEvaluate() ä¼šåœ¨å½“å‰ Project é…ç½®å®Œæˆåå›è°ƒï¼Œè¿™ä¸ªæ—¶æœºæ‰©å±•é…ç½®ä»£ç å·²ç»æ‰§è¡Œï¼Œåœ¨æ’ä»¶å†…éƒ¨å°±å¯ä»¥æ­£ç¡®è·å–é…ç½®å€¼ã€‚
>
> å¦‚ä»¥ä¸‹ä»£ç ä¸­ï¼š
>
> ```groovy
> apply plugin: 'com.pengxr.easyupload'
> 
> // æ‰§è¡Œæ—¶æœºæ™šäº apply
> upload {
>     name = "Peng"
> }
> ```

æ­¤æ—¶æˆ‘ä»¬å°±å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹è°ƒç”¨äº†ï¼š

```
// åŒé¡¹ç›®çš„å¦ä¸€ä¸ªæ¨¡å—ä¸‹é¢ï¼Œä¸Šä¸€èŠ‚ä¸­ä½¿ç”¨çš„ä½ç½®ï¼Œæ³¨æ„æ­¤æ—¶è®¾ç½®äº†æ‹“å±•å‚æ•°

apply plugin: 'com.example.easyupload'
cl {
    name = "SiSi"
    id = "123"
}
```

æ­¤æ—¶å°±èƒ½å¤Ÿæ­£ç¡®å¾—åˆ°ç»“æœï¼š

```
> Configure project :app
----------------
Hello plugin!!!
----------------
++++++++++++++++++
name=SiSi, id=123
++++++++++++++++++
```

å¦‚æœæ²¡æœ‰è®¾ç½®ç”Ÿå‘½å‘¨æœŸç›‘å¬æ˜¯è¿™æ ·çš„ï¼š

```
> Configure project :app
----------------
Hello plugin!!!
----------------
++++++++++++++++++
name=, id=
++++++++++++++++++
```

# ä¸‰ã€è¿›é˜¶å¤„ç†

## Transform

ä¸€ä¸ªç®€å•ä¾‹å­ğŸŒ°ï¼š





### 7.4 ä¹‹åçš„æ–¹æ¡ˆ

```kotlin
/**
 * Defines all possible operations on a [ScopedArtifact] artifact type.
 *
 * Depending on the scope, inputs may contain a mix of [org.gradle.api.file.FileCollection],
 * [RegularFile] or [Directory] so all [Task] consuming the current value of the artifact must
 * provide two input fields that will contain the list of [RegularFile] and [Directory].
 *
 */
interface ScopedArtifactsOperation<T: Task> {

    /**
     * Append a new [FileSystemLocation] (basically, either a [Directory] or a [RegularFile]) to
     * the artifact type referenced by [to]
     *
     * @param to the [ScopedArtifact] to add the [with] to.
     * @param with lambda that returns the [Property] used by the [Task] to save the appended
     * element. The [Property] value will be automatically set by the Android Gradle Plugin and its
     * location should not be considered part of the API and can change in the future.
     */
    fun toAppend(
        to: ScopedArtifact,
        with: (T) -> Property<out FileSystemLocation>,
    )

    /**
     * Set the final version of the [type] artifact to the input fields of the [Task] [T].
     * Those input fields should be annotated with [org.gradle.api.tasks.InputFiles] for Gradle to
     * property set the task dependency.
     *
     * @param type the [ScopedArtifact] to obtain the final value of.
     * @param inputJars lambda that returns a [ListProperty] or [RegularFile] that will be used to
     * set all incoming files for this artifact type.
     * @param inputDirectories lambda that returns a [ListProperty] or [Directory] that will be used
     * to set all incoming directories for this artifact type.
     */
    fun toGet(
        type: ScopedArtifact,
        inputJars: (T) -> ListProperty<RegularFile>,
        inputDirectories: (T) -> ListProperty<Directory>)

    /**
     * Transform the current version of the [type] artifact into a new version. The order in which
     * the transforms are applied is directly set by the order of this method call. First come,
     * first served, last one provides the final version of the artifacts.
     *
     * @param type the [ScopedArtifact] to transform.
     * @param inputJars lambda that returns a [ListProperty] or [RegularFile] that will be used to
     * set all incoming files for this artifact type.
     * @param inputDirectories lambda that returns a [ListProperty] or [Directory] that will be used
     * to set all incoming directories for this artifact type.
     * @param into lambda that returns the [Property] used by the [Task] to save the transformed
     * element. The [Property] value will be automatically set by the Android Gradle Plugin and its
     * location should not be considered part of the API and can change in the future.
     */
    fun toTransform(
        type: ScopedArtifact,
        inputJars: (T) -> ListProperty<RegularFile>,
        inputDirectories: (T) -> ListProperty<Directory>,
        into: (T) -> RegularFileProperty)

    /**
     * Transform the current version of the [type] artifact into a new version. The order in which
     * the replace [Task]s are applied is directly set by the order of this method call. Last one
     * wins and none of the previously set append/transform/replace registered [Task]s will be
     * invoked since this [Task] [T] replace the final version.
     *
     * @param type the [ScopedArtifact] to replace.
     * @param into lambda that returns the [Property] used by the [Task] to save the replaced
     * element. The [Property] value will be automatically set by the Android Gradle Plugin and its
     * location should not be considered part of the API and can change in the future.
     */
    fun toReplace(
        type: ScopedArtifact,
        into: (T) -> RegularFileProperty
    )
}
```

